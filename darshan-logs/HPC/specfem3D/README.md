# Benchmark Description
This is a tiny benchmark of a simulation over 1x64x64 grid and 1 minutie of seismic record. 
ADIOS running on top of MPI-IO is used in this run. 
Note that the Specfem3D simulation runs with two steps, the first step is called `xmeshfem3D`, which generates the cube-sphere mesh for the simulation.
Then, the `xspecfem3D` runs the actual simulation with that mesh. 
In a typical seismic research, the `xmeshfem3D` usually runs once, but the `xspecfem3D` runs multiple times especially in a inversion workflow.
Here, we recorded the darshan logs for both application, but it is not necessarily required to analyse the IO dependency between `xmeshfem3D` and `xspecfem3D`.

### Build Instruction
1. To enable ADIOS, we need to install ADIOS 1.x first. 
Note that the ADIOS 2 is not supported. 
Download it from http://users.nccs.gov/~pnorbert/adios-1.13.1.tar.gz and then untar it to `/path/to/adios`
    1. `cd /path/to/adios; mkdir build; cd build;`
    2. Assume default intel and impi modules are loaded. Configure the build with: 
    ```
    ../configure -prefix=/path/to/adios/install MPICC=mpicc MPICXX=mpicxx MPIFC=mpiifort CC=icc CXX=icpc FC=ifort
    make
    make install
    ```
    Now, the package should be installed in `/path/to/adios/install`
    
2. Download specfem3D_Globe from https://github.com/geodynamics/specfem3d_globe/archive/v7.0.2.tar.gz and untar it to `/path/to/specfem`
    1. To configure the build for CLX nodes, use the following command:
    ```
    ./configure --with-adios ADIOS_CONFIG=/path/to/adios/install/bin/adios_config FC=ifort MPIFC=mpiifort CC=icc CXX=icpc CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" CXXFLAGS="-O3 -xCORE-AVX512" --enable-openmp
    ```
    2. To configure the build for RTX nodes, use the following command:
    ```
    ./configure --with-cuda=cuda5 --with-adios ADIOS_CONFIG=/path/to/adios/install/bin/adios_config MPI_INC=/opt/intel/compilers_and_libraries_2020.1.217/linux/mpi/intel64/include CUDA_LIB=/opt/apps/cuda/10.1/lib64 CUDA_INC=/opt/apps/cuda/10.1/include FC=mpif90 MPIFC=mpif90 CC=mpicc CXX=icpc CFLAGS="-O3 -axCORE-AVX2 -fpic -shared-intel -mcmodel=large  -Wl,--no-relax" FCFLAGS="-O3 -axCORE-AVX2 -fpic -shared-intel -mcmodel=large  -Wl,--no-relax" CXXFLAGS="-O3 -axCORE-AVX2"
    ```
    3. Note that we don't need to run make at the moment, but you can certainly run it to verify the config is correct.

3. Now, we can start running the test. 
Note that specfem3D statically compiles the problem and runtime setup into the binary, so we need to recompile it all the times when anything is changed. 
    1. Get the test setup by copying this dir: `/scratch1/06058/iwang/share/tinytest_rtx_8_adios` to `/path/to/test`
    2. The first thing to change is line 14 of `run_this_example.sh`. Change the rootdir your specfem path.
    3. Run: `./run_this_example.sh`
       and it should create an empty `DATABASES_MPI` directory, a non-empty `OUTPUT_FILES` directory. 
       It will also create some symbolic links under the `DATA` directory.
    4. Run: `sbatch go_all.bash`
       and it will submit this 2 node 8 GPU job. 
       This job should finish within a minute, and you can inspect the stdout in `OUTPUT_FILES/job.o`. 
       The log of `xmeshfem3D` is `OUTPUT_FILES/output_mesher.txt`, and the log of `xspecfem3D` is `OUTPUT_FILES/output_solver.txt`.

4. To modify the test, you will need to change the parameters in `DATA/Par_file`.
    1. `NEX_XI` and `NEX_ETA` controls the problem size by changing the size of the mesh. 
       Note that they must be multiple of 16 and 8 * multiple of the NPROC parameters below. 
    2. `RECORD_LENGTH_IN_MINUTES` controls the problem size by changing the totally timesteps of the simulation.
    3. `NPROC_XI` and `NPROC_ETA` times together is the total number of MPI tasks for the run. 
       For GPU runs, it maps one MPI task to one GPU. 
    4. To run on CPU nodes, change the `GPU_MODE` to `.false.`.
5. Specfem3D does its IO to local directory by default. 
   To direct the IO to other directories, there are two parameters need to be changed before compiling.
    1. In `DATA/Par_file`, change the `LOCAL_PATH` and `LOCAL_TMP_PATH`.
    2. In `/path/to/specfem/setup/constants.h`,change the `OUTPUT_FILES_BASE` to a desired directory. 
       Note that you probably will need to copy the `OUTPUT_FILES` directory generated by the `run_this_example.sh` script to wherever you specified. 

### Analysis

The first job, `xmeshfem3D`, accessed 13 files, and had conflicts in three of them, all with the ".bp" suffix. Rank 0 read and write the data and another rank wrote it.
```
/scratch1/06058/iwang/benchmarks/specfem3d/tinytest_rtx_8_adios_darshan/DATABASES_MPI/boundary.bp
  bytes 7391612..7413468: write ranks={1} read/write ranks={0}
  bytes 7413469..7435325: write ranks={2} read/write ranks={0}
  bytes 7435326..7448165: write ranks={3} read/write ranks={0}

/scratch1/06058/iwang/benchmarks/specfem3d/tinytest_rtx_8_adios_darshan/DATABASES_MPI/solver_data_mpi.bp
  bytes 1441851..1445354: write ranks={1} read/write ranks={0}
  bytes 1445355..1450146: write ranks={2} read/write ranks={0}
  bytes 1450147..1454938: write ranks={3} read/write ranks={0}
  bytes 1454939..1459730: write ranks={4} read/write ranks={0}
  bytes 1459731..1459741: write ranks={5} read/write ranks={0}
  
/scratch1/06058/iwang/benchmarks/specfem3d/tinytest_rtx_8_adios_darshan/DATABASES_MPI/stacey.bp
  bytes 149413..154606: write ranks={1} read/write ranks={0}
  bytes 154607..156013: write ranks={2} read/write ranks={0}
  bytes 187653..189534: write ranks={1} read/write ranks={0}
  bytes 189535..191416: write ranks={2} read/write ranks={0}
  bytes 191417..193298: write ranks={3} read/write ranks={0}
  bytes 193299..195180: write ranks={4} read/write ranks={0}
  bytes 195181..197062: write ranks={5} read/write ranks={0}
  bytes 197063..198944: write ranks={6} read/write ranks={0}
  bytes 198945..200826: write ranks={7} read/write ranks={0}
```

The second job, `xspecfem3D`, accesses 494 files and has no conflicts. 485 of the files are written by a single process, and 9 of them are only read.

Commands used:
```
darshan_dxt_conflicts -verbose=2 xmeshfem3D_dxt.log
darshan_dxt_conflicts -verbose=1 xspecfem3D_dxt.log
```
