# Benchmark Description
This is a tiny benchmark of a simulation over 1x64x64 grid and 1 minutie of seismic record. 
ADIOS running on top of MPI-IO is used in this run. 
Note that the Specfem3D simulation runs with two steps, the first step is called `xmeshfem3D`, which generates the cube-sphere mesh for the simulation.
Then, the `xspecfem3D` runs the actual simulation with that mesh. 
In a typical seismic research, the `xmeshfem3D` usually runs once, but the `xspecfem3D` runs multiple times especially in a inversion workflow.
Here, we recorded the darshan logs for both application, but it is not necessarily required to analyse the IO dependency between `xmeshfem3D` and `xspecfem3D`.

### Build Instruction
1. To enable ADIOS, we need to install ADIOS 1.x first. 
Note that the ADIOS 2 is not supported. 
Download it from http://users.nccs.gov/~pnorbert/adios-1.13.1.tar.gz and then untar it to `/path/to/adios`
    1. `cd /path/to/adios; mkdir build; cd build;`
    2. Assume default intel and impi modules are loaded. Configure the build with: 
    ```
    ../configure -prefix=/path/to/adios/install MPICC=mpicc MPICXX=mpicxx MPIFC=mpiifort CC=icc CXX=icpc FC=ifort
    make
    make install
    ```
    Now, the package should be installed in `/path/to/adios/install`
    
2. Download specfem3D_Globe from https://github.com/geodynamics/specfem3d_globe/archive/v7.0.2.tar.gz and untar it to `/path/to/specfem`
    1. To configure the build for CLX nodes, use the following command:
    ```
    ./configure --with-adios ADIOS_CONFIG=/path/to/adios/install/bin/adios_config FC=ifort MPIFC=mpiifort CC=icc CXX=icpc CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" CXXFLAGS="-O3 -xCORE-AVX512" --enable-openmp
    ```
    2. To configure the build for RTX nodes, use the following command:
    ```
    ./configure --with-cuda=cuda5 --with-adios ADIOS_CONFIG=/path/to/adios/install/bin/adios_config MPI_INC=/opt/intel/compilers_and_libraries_2020.1.217/linux/mpi/intel64/include CUDA_LIB=/opt/apps/cuda/10.1/lib64 CUDA_INC=/opt/apps/cuda/10.1/include FC=mpif90 MPIFC=mpif90 CC=mpicc CXX=icpc CFLAGS="-O3 -axCORE-AVX2 -fpic -shared-intel -mcmodel=large  -Wl,--no-relax" FCFLAGS="-O3 -axCORE-AVX2 -fpic -shared-intel -mcmodel=large  -Wl,--no-relax" CXXFLAGS="-O3 -axCORE-AVX2"
    ```
    3. Note that we don't need to run make at the moment, but you can certainly run it to verify the config is correct.

3. Now, we can start running the test. 
Note that specfem3D statically compiles the problem and runtime setup into the binary, so we need to recompile it all the times when anything is changed. 
    1. Get the test setup by copying this dir: `/scratch1/06058/iwang/share/tinytest_rtx_8_adios` to `/path/to/test`
    2. The first thing to change is line 14 of `run_this_example.sh`. Change the rootdir your specfem path.
    3. Run: `./run_this_example.sh`
       and it should create an empty `DATABASES_MPI` directory, a non-empty `OUTPUT_FILES` directory. 
       It will also create some symbolic links under the `DATA` directory.
    4. Run: `sbatch go_all.bash`
       and it will submit this 2 node 8 GPU job. 
       This job should finish within a minute, and you can inspect the stdout in `OUTPUT_FILES/job.o`. 
       The log of `xmeshfem3D` is `OUTPUT_FILES/output_mesher.txt`, and the log of `xspecfem3D` is `OUTPUT_FILES/output_solver.txt`.

4. To modify the test, you will need to change the parameters in `DATA/Par_file`.
    1. `NEX_XI` and `NEX_ETA` controls the problem size by changing the size of the mesh. 
       Note that they must be multiple of 16 and 8 * multiple of the NPROC parameters below. 
    2. `RECORD_LENGTH_IN_MINUTES` controls the problem size by changing the totally timesteps of the simulation.
    3. `NPROC_XI` and `NPROC_ETA` times together is the total number of MPI tasks for the run. 
       For GPU runs, it maps one MPI task to one GPU. 
    4. To run on CPU nodes, change the `GPU_MODE` to `.false.`.
5. Specfem3D does its IO to local directory by default. 
   To direct the IO to other directories, there are two parameters need to be changed before compiling.
    1. In `DATA/Par_file`, change the `LOCAL_PATH` and `LOCAL_TMP_PATH`.
    2. In `/path/to/specfem/setup/constants.h`,change the `OUTPUT_FILES_BASE` to a desired directory. 
       Note that you probably will need to copy the `OUTPUT_FILES` directory generated by the `run_this_example.sh` script to wherever you specified. 

### Analysis

Using  `darshan_dxt_conflicts` to scan for conflicts, where a conflict is defined as a range of bytes that is read or written by more than one process, and at least one of those acesses is a write.

        ./darshan_dxt_conflicts ../HPC/specfem3D/xmeshfem3D_dxt.log
        
Three files have write-after-write conflicts, and they all have a ".bp" suffix. In each case, both rank 0 and some other rank write to a subrange of the file.  The subranges vary form 10 bytes to 21856 bytes.

        /scratch1/06058/iwang/benchmarks/specfem3d/tinytest_rtx_8_adios_darshan/DATABASES_MPI/boundary.bp
          CONFLICT bytes 7391612..7413468: writers=0,1
          CONFLICT bytes 7413469..7435325: writers=0,2
          CONFLICT bytes 7435326..7448165: writers=0,3
        
        /scratch1/06058/iwang/benchmarks/specfem3d/tinytest_rtx_8_adios_darshan/DATABASES_MPI/solver_data_mpi.bp
          CONFLICT bytes 1441851..1445354: writers=0,1
          CONFLICT bytes 1445355..1450146: writers=0,2
          CONFLICT bytes 1450147..1454938: writers=0,3
          CONFLICT bytes 1454939..1459730: writers=0,4
          CONFLICT bytes 1459731..1459741: writers=0,5
        
        /scratch1/06058/iwang/benchmarks/specfem3d/tinytest_rtx_8_adios_darshan/DATABASES_MPI/stacey.bp
          CONFLICT bytes 149413..154606: writers=0,1
          CONFLICT bytes 154607..156013: writers=0,2
          CONFLICT bytes 187653..189534: writers=0,1
          CONFLICT bytes 189535..191416: writers=0,2
          CONFLICT bytes 191417..193298: writers=0,3
          CONFLICT bytes 193299..195180: writers=0,4
          CONFLICT bytes 195181..197062: writers=0,5
          CONFLICT bytes 197063..198944: writers=0,6
          CONFLICT bytes 198945..200826: writers=0,7


TODO: detect false sharing, where two writers modify non-overlapping data in the same block.
